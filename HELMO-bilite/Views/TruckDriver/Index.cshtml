@model List<IGrouping<int, DeliveryModel>>
@{
    int currentWeekOffset = ViewBag.WeekOffset;
    DateTime startOfWeek = ViewBag.StartOfWeek;
    DateTime endOfWeek = ViewBag.EndOfWeek;
}

<div class="h-100 vw-100 p-5">
<div class="container mt-3">
    <div class="row">
        <div class="col-12 col-sm-4 text-sm-end mb-3 mb-sm-0">
            <a href="@Url.Action("Index", "TruckDriver", new { weekOffset = currentWeekOffset - 1 })" class="me-5 btn btn-warning fw-bold">
                  <i class="fas fa-arrow-left"></i> Semaine précédente
            </a>
        </div>
        <div class="col-12 col-sm-4 text-center mb-3 mb-sm-0">
            <h4>@startOfWeek.ToString("dd/MM/yyyy") au @endOfWeek.ToString("dd/MM/yyyy")</h4>
        </div>
        <div class="col-12 col-sm-4 text-sm-start">
            <a href="@Url.Action("Index", "TruckDriver", new { weekOffset = currentWeekOffset + 1 })" class="me-5 btn btn-warning fw-bold" >
                Semaine suivante  <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
</div>
@if (TempData["NotificationMessage"] != null && TempData["IsSuccess"] != null)
{
    <div class="alert @((bool)TempData["IsSuccess"] ? "alert-success" : "alert-warning") mt-2">
        @TempData["NotificationMessage"]
    </div>
}
@if (Model != null && Model.Any())
{
    <table class="table table-striped table-bordered border-5 mt-3">
        <thead class="bg-warning">
            <tr>
                <th scope="col"><i class="fa-solid fa-hashtag"></i></th>
                <th scope="col"><i class="fa-solid fa-location-dot"></i> Lieu de chargement</th>
                <th scope="col"><i class="fa-solid fa-location-dot"></i> Lieu de déchargement</th>
                <th scope="col"><i class="fa-solid fa-box"></i> Contenu</th>
                <th scope="col"><i class="fa-solid fa-calendar-days"></i> Date et heure de chargement</th>
                <th scope="col"><i class="fa-solid fa-calendar-days"></i> Date et heure de déchargement</th>
                <th scope="col"><i class="fas fa-circle-notch fa-spin"></i> Statut</th>
                <th scope="col"><i class="fa-solid fa-list-ul"></i> Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var delivery in Model.SelectMany(g => g))
            {
                <tr>
                    <td>@delivery.IdDelivery</td>
                    <td>@delivery.PlaceLoadingDelivery</td>
                    <td>@delivery.PlaceUnLoadingDeliver</td>
                    <td>@delivery.Content</td>
                    <td>@delivery.DateAndTimeOfLoading</td>
                    <td>@delivery.DateAndTimeOfUnLoading</td>
                    <td>@(delivery.IsFinish ? "Terminée" : "En cours")</td>
                    <td>
                        <button class="btn btn-warning fw-bold btn-sm" data-bs-toggle="modal" data-bs-target="#completeDeliveryModal" data-bs-id="@delivery.IdDelivery">Valider la livraison</button>
                        <button class="btn btn-danger fw-bold btn-sm" data-bs-toggle="modal" data-bs-target="#incompleteDeliveryModal" data-bs-id="@delivery.IdDelivery">Livraison non terminée</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info mt-3">
        Aucune livraison à afficher pour cette semaine.
    </div>
}
</div>

    <!-- Valider la livraison Modal -->
<div class="modal fade" id="completeDeliveryModal" tabindex="-1" role="dialog" aria-labelledby="completeDeliveryModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="completeDeliveryModalLabel">Valider la livraison</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form asp-controller="TruckDriver" asp-action="ProcessDelivery">
          <div class="modal-body">
              <div class="alert alert-danger modal-error" style="display:none;">
              @if (TempData["ModalError"] != null)
              {
                  <div class="alert alert-danger">
                      @TempData["ModalError"]
                  </div>
              }
              </div>
              <input type="hidden" name="IdDelivery" id="completeDeliveryId"/>
              <input type="hidden" name="currentWeekOffset" value="@currentWeekOffset"/>
              <input type="hidden" name="IsSuccess" value="true"/>
              <div class="form-group">
                  <label for="comment">Commentaire</label>
                  <textarea class="form-control" name="Comment" id="comment" rows="3" required title="Veuillez indiquer un commentaire."></textarea>
              </div>
          </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger fw-bold" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-warning fw-bold">Valider la livraison</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Livraison non terminée Modal -->
<div class="modal fade" id="incompleteDeliveryModal" tabindex="-1" role="dialog" aria-labelledby="incompleteDeliveryModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="incompleteDeliveryModalLabel">Livraison non terminée</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form asp-controller="TruckDriver" asp-action="ProcessDelivery">
          <div class="modal-body">
              <div class="alert alert-danger modal-error" style="display:none;">
              @if (TempData["ModalError"] != null)
              {
                  <div class="alert alert-danger">
                      @TempData["ModalError"]
                  </div>
              }
              </div>
              <input type="hidden" name="IdDelivery" id="incompleteDeliveryId"/>
              <input type="hidden" name="currentWeekOffset" value="@currentWeekOffset"/>
              <input type="hidden" name="IsSuccess" value="false"/>
              <div class="form-group">
                  <label for="reason">Motif</label>
                  <select class="form-select" name="Comment" id="reason" required title="Veuillez sélectionner un motif.">
                      <option>Maladie</option>
                      <option>Accident (lors du trajet de la livraison)</option>
                      <option>Client absent / Livraison impossible</option>
                  </select>
              </div>
          </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger fw-bold" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-warning fw-bold">Soumettre le motif</button>
        </div>
      </form>
    </div>
  </div>
</div>


@section Scripts {
    <script>
       $('#completeDeliveryModal').on('show.bs.modal', function (event) {
           const button = $(event.relatedTarget);
           const id = button.data('bs-id');
           const modal = $(this);
           modal.find('#completeDeliveryId').val(id);
       });
       
       $('#incompleteDeliveryModal').on('show.bs.modal', function (event) {
           const button = $(event.relatedTarget);
           const id = button.data('bs-id');
           const modal = $(this);
           modal.find('#incompleteDeliveryId').val(id);
           });
           
           // Message d'erreur dans une modal
        $(document).ready(function() {
            @if (TempData["ModalError"] != null && TempData["ModalId"] != null)
            {
                // Bien indiquer la balise text pour dire à Razor qu'il faut traiter le contenu à l'intérieur
                // comme du texte brut, sans interprétation des balises html comme c'est un message d'erreur
                <text>
                const modalErrorText = "@TempData["ModalError"]";
                const modalId = "@TempData["ModalId"]";
                $("#" + modalId + " .modal-error").text(modalErrorText).show();
                $("#" + modalId).modal("show");
                </text>
            }
        });
    </script>
}

